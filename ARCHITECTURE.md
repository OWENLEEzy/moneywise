# Moneywise Architecture & Configuration

This document describes the high-level architecture, design patterns, and project structure of the **Moneywise** iOS application.

## Overview
Moneywise is an intelligent personal finance tracker built with **SwiftUI** and **SwiftData**. It leverages **Generative AI (Gemini)** to simplify transaction entry through natural language processing (text and voice) and provides automated financial insights.

## Architecture Pattern
The application follows the **MVVM (Model-View-ViewModel)** architectural pattern to ensure separation of concerns and testability.

- **Models**: SwiftData entities representing the persistent state (Transactions, Goals, Categories).
- **Views**: Declarative SwiftUI views that display data and capture user interaction.
- **ViewModels**: Observable objects that manage UI state, mediate between Views and Services, and handle business logic (e.g., `AISmartEntryViewModel`).
- **Services**: Encapsulated logic for external operations (Networking, AI, Sensors, Persistence helpers).

## Architecture Layers

```
Moneywise
â”œâ”€â”€ MoneywiseApp.swift        // SwiftData Container, Dependency Injection
â”œâ”€â”€ Models/                   // @Model Data Structures, Environment Keys
â”œâ”€â”€ ViewModels/               // Business State (GoalManager, AI Config, Routing)
â”œâ”€â”€ Services/                 // AI/Keychain/CSV/Notification Logic
â”œâ”€â”€ Views/                    // SwiftUI Pages (Grouped by IA)
â””â”€â”€ Resources/                // Static Resources
```

- **UI**: Simplified `TabView` (Home, Transactions, Reports, Goals, Assistant). Settings accessed via Home View toolbar (top-right). Reports and Goals views feature a "Back" button to return to Home. `FloatingButtonBar` for quick navigation. All amounts use Coin Emoji ðŸª™. **Full English Interface**.
- **State**: Official `Observation` + `SwiftData`. `GoalManager`, `AIConfigurationStore` in Environment.
- **Data**: SwiftData auto-generates SQLite tables, using `@Model` for `Transaction/Goal/AIInsight...`; Full CSV Import/Export (`CSVService`+UI) with de-duplication.
- **AI**: `GeminiService` uses Gemini 2.5 Flash model. Token usage tracked and displayed in Settings.
- **Security**: Keychain stores API Key. Data stored locally in sandbox.
- **Reminders**: `NotificationScheduler` fully implemented for daily logging and goal deadlines.

## Project Structure Details

### 1. Root
- **MoneywiseApp.swift**: Application entry point, sets up the ModelContainer for SwiftData.
- **ContentView.swift**: The main navigation hub, managing the `TabView` and deep links.

### 2. Models (`/Models`)
Persistent data models using the `SwiftData` framework:
- **Transaction**: The core entity recording expenses and income. Includes fields for AI confidence scores.
- **SpendingCategory**: User-customizable categories (e.g., Food, Transport) with associated icons and colors.
- **Goal**: Savings targets with progress tracking.
- **AIInsight**: Cached analysis and summaries generated by Gemini.
- **BudgetReminder**: Scheduled notifications for logging and goals.
- **SettingItem**: Key-value storage for app configuration (API keys, flags).

### 3. Views (`/Views`)
Organized by feature:
- **Home**: Dashboard showing today's summary, asset overview, and quick actions.
- **Assistant**: Logic for AI interaction (likely conversational UI).
- **Transactions**: List and filter historical transactions.
- **Reports**: Charts and visualization of spending trends.
- **Goals**: Measurement of financial goals.
- **Shared**: Reusable components, notably `EntrySheets.swift` (Manual & AI entry forms).

### 4. Services (`/Services`)
Core logic separation:
- **AIService.swift**: Facade for interacting with Gemini. Handles text parsing, sentiment analysis, and insight generation.
- **GeminiService.swift**: Low-level networking layer for the Gemini API, handling retry logic and error mapping.
- **SpeechRecognitionService.swift**: Manages `SFSpeechRecognizer` for voice-to-text input.
- **NotificationService.swift**: Manages local push notifications.
- **LanguageManager.swift**: Handles app-specific localization logic.

### 5. ViewModels (`/ViewModels`)
- **AISmartEntryViewModel**: Manages the state of the AI entry sheet, handling the conversation flow, calling `AIService`, and parsing results into `Transaction` objects.

## Key Workflows & Data Flows

### AI Speedy Entry
1. User taps the bottom center AI button (Brain Icon) to open `AISmartEntrySheet`.
2. **Input**: Type description directly, or **Voice Input** (tap mic) to transcribe via `SFSpeechRecognizer`.
3. **Processing**: `AISmartEntryViewModel` sends input to `AIService`.
4. **Parsing**: `AIService` calls `GeminiService` (Gemini 2.5 Flash) to parse unstructured text into structured JSON.
5. **Confirmation**: User reviews the parsed transaction in `TransactionConfirmationCard`.
   - **Confidence â‰¥ 0.8**: Auto-starts 3s countdown, cancelable.
   - **Confidence < 0.8**: Warning shown, manual confirmation required.
6. **Persistence**: Confirmed transaction is inserted into SwiftData; token usage recorded.

### Hints & Reporting
1. **Aggregation**: Transactions are fetched from SwiftData.
2. **Analysis**: `AIService` sends aggregated data summaries to Gemini.
3. **Presentation**: Returned insights are stored in `AIInsight` models and displayed in `ReportsView` (Weekly/Monthly).
4. **Chat**: Users can open the conversational assistant for specific questions.

### CSV Import/Export
1. **Export**: Settings -> "Export Transactions" -> `CSVService.export()` generates CSV -> System Share Sheet.
2. **Import**: Settings -> "Import Transactions" -> Select CSV -> `CSVService.import()` parses -> Smart De-duplication -> Import Result Stats.

## Current Implementation Status

### âœ… Completed Core Features (100%)
- **AI Config**: Full API Key management (Input, Save, Test, Help, Usage Stats)
- **AI Entry**: Text & Voice input parsing, Gemini 2.5 Flash
- **Voice to Text**: Integrated SFSpeechRecognizer, English real-time transcription
- **3s Auto-Confirm**: Confidence-based countdown, cancelable
- **CSV Import/Export**: Full UI & Backend, Share, De-duplication
- **API Stats**: Token usage, Call count, Pricing link
- **Goal Management**: Create, List, Details, Progress tracking
- **Transactions**: Search, Filter (All/Expense/Income), Swipe delete
- **Reminders**: Daily & Goal reminders (Backend + UI)
- **Data Models**: Transaction, Goal, SpendingCategory, AIUsageStats, AIInsight
- **Storage**: SwiftData + Keychain
- **Reports**: Trend Chart, AI Weekly/Monthly Insights, AI Chat
- **UI Design**: Modern interface, Coin emoji, Floating button, **English/mandarin Localization**

## Technical Highlights
- âœ… Modern SwiftUI + SwiftData Architecture
- âœ… Complete Local Data Loop (Import/Export/De-dupe)
- âœ… Smart AI Interaction (Auto-confirm countdown)
- âœ… Secure Keychain Storage
- âœ… UX Optimization (Haptics, Loading States, Error Handling)
- âœ… Full English Localization
- âœ… Build Ready & Runnable

---
config:
  layout: dagre
---
flowchart TB
    Start(["App Launch"]) --> Home["Home (Overview)"]
    Home -- Tab Bar --> Transactions["Transactions List"] & Reports["Reports"] & Goals["Goals"]
    Home -- Toolbar --> Settings["Settings"]
    Home -- Floating Button --> AIEntry{"AI Entry (Voice/Text)"}
    AIEntry --> Gemini[("Gemini API")]
    Gemini --> Confirmation["Confirmation Card"]
    Confirmation -- "Save/Auto-confirm" --> SaveTransaction[("Save to SwiftData")]
    AIEntry -- Manual Toggle --> ManualEntry["Manual Entry Sheet"]
    ManualEntry -- Save --> SaveTransaction
    Transactions -- Tap Card --> EditDelete{"Edit/Delete data"}
    EditDelete -- Edit/Update --> SaveTransaction
    Reports -- SwiftData Query --> ReportVisuals[("Visual Charts (Pie/Line)")]
    Reports -- Generate --> AIInsights["AI Insights"]
    Reports -- Chat --> AIChat["AI Report Assistant"]
    Goals -- View Data --> GoalList[("Goal List (All Goal Info)")]
    Goals -- Add/Manage Funds --> GoalManagement["New Goal/Add Funds"]
    GoalManagement --> SaveTransaction
    Settings -- Export/Import --> CSV["CSV Service"]
    Settings -- Manage --> Categories["Category Management"]
    Settings --> APIConfig["API Configuration"]
    SaveTransaction --> Transactions & Reports & Goals